# Maintainer: gearhead
# Contributor:

pkgname=i-sabre-k2m-rune
_pkgname=I-Sabre-K2M
pkgver=0.r9.c759ff5
pkgrel=1
pkgdesc="i-sabre-k2m kernel module"
url="https://github.com/audiophonics/I-Sabre-K2M"
arch=('armv6h' 'armv7h')
license=('GPLv2')
# had to comment the next line for armv6. this causes the modules to be put
# in the incorrect directory. I am building on a chroot on a B3+
#depends=('linux')
makedepends=('linux-headers' 'git')
#provides=('i-sabre-k2m.ko.gz')
#conflicts=('i-sabre-k2m.ko.gz')
	
source=("$_pkgname::git+https://github.com/audiophonics/I-Sabre-K2M.git")
sha256sums=('SKIP')

_extramodules="$(basename $(readlink -f /lib/modules/$(uname -r)/extramodules/))"

pkgver() {
  cd "$_pkgname"
  printf "0.r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/"$_pkgname"
msg2 "patching 4-14 k2m code for 4.19"
patch -Np1 -i ../../0001-Fixed-k2m-module-to-build-for-kernel-4.19.patch
}

build() {
  cd "${srcdir}"/"$_pkgname"
msg2 "Making modules"
  make
msg2 "Making overlay"
  make dtbs
msg2 "gzip-ing modules"
  gzip -9 *.ko
}
	
package() {
  _kernver=$(pacman -Q linux | sed -r 's#.* ([0-9]+\.[0-9]+).*#\1#')
  #depends=("linux>=$_kernver" "linux<${_kernver/.*}.$(expr ${_kernver/*.} + 1)")
  #KERNEL_VERSION=$(cat /usr/lib/modules/extramodules-$_kernver-ARCH/version)
  #msg "Kernel = $KERNEL_VERSION"

  cd "$srcdir"/"$_pkgname"
msg2 "in src dir, next is modules_install"
  # make DESTDIR="${pkgdir}/" modules_install
  # copy systemd files
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-k2m.ko.gz" \
	"$pkgdir/usr/lib/modules/extramodules-$_kernver-raspberrypi/i-sabre-k2m.ko.gz"
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-k2m-codec.ko.gz" \
	"$pkgdir/usr/lib/modules/extramodules-$_kernver-raspberrypi/i-sabre-k2m-codec.ko.gz"
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-k2m.dtbo" \
	"$pkgdir/boot/overlays/i-sabre-k2m.dtbo"
}
