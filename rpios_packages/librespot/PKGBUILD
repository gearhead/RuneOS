# Maintainer: Christoph Gysin <christoph.gysin@gmail.com>

pkgname=librespot
pkgver=0.4.2
pkgrel=1
epoch=1
pkgdesc="Open Source Spotify client library"
arch=('arm64' 'armhf')
url="https://github.com/librespot-org/librespot"
license=('MIT')
depends=('libvorbis0a' 'libasound2')
makedepends=('git' 'libasound2-dev' 'pkg-config' 'libjack-dev' 'libsdl2-dev')
provides=('librespot')
conflicts=('librespot')
source=("$pkgname::git+https://github.com/librespot-org/librespot.git")
sha256sums=('SKIP')

prepare() {
    cd "$pkgname"
    git checkout v$pkgver
    git submodule update --init --recursive

    case "$CARCH" in
      armv6h) target=arm-unknown-linux-gnueabihf;;
      armv7h) target=armv7-unknown-linux-gnueabihf;;
      arm64) target=aarch64-unknown-linux-gnu;;
      *)      target="$CARCH-unknown-linux-gnu";;
    esac

#    cargo fetch \
#        --locked \
#        --target "$target"
}

build() {
    cd "$srcdir/$pkgname"
    cargo build --release
}

package() {
    cd "$srcdir/$pkgname"
    cargo install \
        --no-track \
        --locked \
        --root "$pkgdir/usr" \
        --path .

    install -D -m 644 contrib/librespot.service \
        "$pkgdir"/usr/lib/systemd/system/librespot.service
    install -D -m 644 contrib/librespot.user.service \
        "$pkgdir"/usr/lib/systemd/user/librespot.service
    install -D -m 644 LICENSE \
        "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}
