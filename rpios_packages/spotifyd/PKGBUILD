# Maintainer: gearhead <ys3al35l at gmail dot com>
# Contributor: Samuel Walladge <samuel+aur@swalladge.net>
# Contributor: Varakh <varakh@varakh.de>

pkgname=spotifyd-full-git
pkgver=0.r254.1336c5e
pkgrel=1
arch=('arm64' 'armhf')
depends=('libpulse0' 'libportaudio2')
license=('GPL3')
makedepends=('git' 'libpulse-dev' 'dbus' 'portaudio19-dev')
conflicts=('spotifyd' 'spotifyd-pulseaudio' 'spotifyd-git' 'spotifyd-bin' 'spotifyd-pulseaudio-git')
provides=('spotifyd')
pkgdesc="A spotify playing daemon (all features enabled)"
url="https://github.com/Spotifyd/spotifyd"
source=("spotifyd::git+https://github.com/Spotifyd/spotifyd"
        'spotifyd.sysusers')
sha256sums=('SKIP'
            'SKIP')

pkgver() {
#  cd $srcdir/spotifyd;
#  git describe --tags --match 'v*' | sed 's/^v//;s/-/./g'
   cd "$_pkgname"
   printf "0.r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"

prepare() {
     cd "$_pkgname"

     case "$CARCH" in
       armv6h) target=arm-unknown-linux-gnueabihf;;
       armv7h) target=armv7-unknown-linux-gnueabihf;;
       arm64) target=aarch64-unknown-linux-gnu;;
       *)      target="$CARCH-unknown-linux-gnu";;
     esac

     cargo fetch \
         --locked \
         --target "$target"
}

}

build() {
  cd $srcdir/spotifyd;
  cargo build --release --all-features
}

package() {
  install -D -m 755 "$srcdir/spotifyd/target/release/spotifyd" "${pkgdir}/usr/bin/spotifyd"
  install -D -m 644 "$srcdir/spotifyd/contrib/spotifyd.service" "${pkgdir}/usr/lib/systemd/user/spotifyd.service"
  install -D -m644 "$srcdir"/spotifyd.sysusers "$pkgdir"/usr/lib/sysusers.d/spotifyd.conf

}
